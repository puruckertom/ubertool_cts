<script type="text/javascript">

$(document).ready(function () {

	var run_data = {{run_data}};
	var json_data = {};

	function parseOutputForCSV() {
		var workflow = getWorkflow(); // get current workflow name

		json_data['workflow'] = workflow;

		try {
			json_data['run_type'] = run_type;
		}
		catch (e) {
			console.log("no run_type variable in this workflow");
		}

		if (workflow == "chemspec") {
			// get batch_data for chemspec batch mode...
			if (window.location.href.indexOf('batch') > -1) {
				json_data['batch_data'] = batch_data;
				json_data['batch_chems'] = batch_chems;
			}
		}

    	else if (workflow == "pchemprop") {
    		// todo: loop props, then calcs so the csv can be ordered by props

    		// todo: use run_type key from response as conditional..
    		if (window.location.href.indexOf('batch') < 0) {
    			// regular single pchem workflow
    			json_data['checkedCalcsAndProps'] = {};
	    		for (var calc in checkedCalcsAndProps) {
	    			if (checkedCalcsAndProps.hasOwnProperty(calc)) {
	    				json_data['checkedCalcsAndProps'][calc] = {};
	    				for (var i = 0; i < checkedCalcsAndProps[calc].length; i++) {
	    					// looping props of calc..
	    					var prop = checkedCalcsAndProps[calc][i];
	    					var data = $('.' + calc + '.' + prop).html();
							if (prop == "ion_con") {
								data = pickOutPka(data);
							}
							if (data != null) {
								json_data['checkedCalcsAndProps'][calc][prop] = data;
							}
	    				}
	    			}
	    		}
    		}
    		else {
    			json_data['batch_data'] = batch_data;
    			json_data['checkedCalcsAndProps'] = checkedCalcsAndProps;
    			json_data['batch_chems'] = batch_chems;
    		}

    		
    	}
    	else if (workflow == "gentrans") {
    		if (run_type == 'batch') {
    			json_data['batch_data'] = batch_data;
    			json_data['checkedCalcsAndProps'] = checkedCalcsAndProps;
    			json_data['batch_chems'] = batch_chems;
    		}
    		else {
    			// buildMetabolitesArray() is for spacetree (i.e., not batch mode)
    			json_data['data'] = buildMetabolitesArray();
    			json_data['checkedCalcsAndProps'] = checkedCalcsAndProps;
    		}
    	}

    	json_data['run_data'] = run_data;
		var cache = [];
		json_data = JSON.stringify(json_data, function(key, value) {
		    if (typeof value === 'object' && value !== null) {
		        if (cache.indexOf(value) !== -1) {
		            return;  // Circular reference found, discard key
		        }
		        cache.push(value);
		    }
		    return value;
		});
		cache = null;  // Enable garbage collection

    	return json_data;
	}


	function parseOutput(file_type) {
		
        var elements, jq_html, imgData_json, n_plot;
        var workflow = getWorkflow(); // get current workflow name
        var options = { x_offset : 30, y_offset : 30 }; // jqplotToImage options
        var imgData = []; // jqplot images
        var jsonData = ""; // json data string (originally intended for metabolites)

        elements = collectDOM(workflow); // get relevant dom objects

   		if (workflow == "chemspec") {
            try {
                imgData.push($('#microspecies-distribution').jqplotToImageStr(options));
                imgData.push($('#isoelectric-point').jqplotToImageStr(options));
            }
            catch(e) { console.log(e); }
        }
        else if (workflow == "gentrans") {
            var nodeArray = buildMetabolitesArray(); // (cts_gentrans_tree)

            var data_obj = {'nodes': nodeArray, 'checkedCalcsAndProps': checkedCalcsAndProps};

            var cache = [];
			// jsonData = JSON.stringify(nodeArray, function(key, value) {
			jsonData = JSON.stringify(data_obj, function(key, value) {
			    if (typeof value === 'object' && value !== null) {
			        if (cache.indexOf(value) !== -1) {
			            // Circular reference found, discard key
			            return;
			        }
			        // Store value in our collection
			        cache.push(value);
			    }
			    return value;
			});
			cache = null; // Enable garbage collection

        }

		jq_html = $('<div />').append($(elements).clone()).html();
		var n_plot_1 = $('#microspecies-distribution').size();
		var n_plot_2 = $('#isoelectric-point').size();
		n_plot = n_plot_1 + n_plot_2;
		imgData_json = JSON.stringify(imgData, null, '\t');

        appendToRequestTable(jq_html, n_plot, imgData_json, jsonData); // append elements to request table

	}

	$('#pdfExport').click(function () {
		parseOutput('pdf');
		$('form').attr({'action': 'pdf', 'method': 'POST'}).submit();
	});

	$('#htmlExport').click(function () {
		parseOutput('html');
		$('form').attr({'action': 'html', 'method': 'POST'}).submit();
	});

	$('#csvExport').click(function () {

        var jsonData = parseOutputForCSV();

		$('table.getpdf').html("");
		$('<tr style="display:none"><td><input type="hidden" name="run_data"></td></tr>')
				.appendTo('.getpdf')
				.find('input')
				.val(jsonData);

		$('form').attr({'action': 'csv', 'method': 'POST'}).submit();

	});


	$('#csv_batch').click(function () {
		$('#csvExport').trigger('click');
	});


	$('#fadeExport_pdf').append('<span class="hover"></span>').each(function () {
		var $span = $('> span.hover', this).css('opacity', 0);
		$(this).hover(function () {
			$span.stop().fadeTo(500, 1);
		}, function () {
			$span.stop().fadeTo(500, 0);
		});
	});
	
	$('#fadeExport_html').append('<span class="hover"></span>').each(function () {
		var $span = $('> span.hover', this).css('opacity', 0);
		$(this).hover(function () {
			$span.stop().fadeTo(500, 1);
		}, function () {
			$span.stop().fadeTo(500, 0);
		});
	});

	$('#fadeExport_csv').append('<span class="hover"></span>').each(function () {
		var $span = $('> span.hover', this).css('opacity', 0);
		$(this).hover(function () {
			$span.stop().fadeTo(500, 1);
		}, function () {
			$span.stop().fadeTo(500, 0);
		});
	});

});


function buildMetabolitesArray() {
	// calls cts_gentrans_tree function getSpaceTree()
	var canvasNodes = getSpaceTree().graph.nodes;
    var nodeArray = [];
    for (var node in canvasNodes) {
        if (canvasNodes.hasOwnProperty(node)) {
            var nodeItem = canvasNodes[node]['data'];
            nodeArray.push(nodeItem);
        }
    }
    return nodeArray;
}


function appendToRequestTable(jq_html, n_plot, imgData_json, jsonData) {
	
	var test = $('table.getpdf');

	$('table.getpdf').html("");
	
	$('<tr style="display:none"><td><input type="hidden" name="pdf_t"></td></tr>')
		.appendTo('.getpdf')
		.find('input')
		.val(jq_html);

	$('<tr style="display:none"><td><input type="hidden" name="pdf_nop"></td></tr>')
		.appendTo('.getpdf')
		.find('input')
		.val(n_plot);

	$('<tr style="display:none"><td><input type="hidden" name="pdf_p"></td></tr>')
		.appendTo('.getpdf')
		.find('input')
		.val(imgData_json);

    $('<tr style="display:none"><td><input type="hidden" name="pdf_json"></td></tr>')
		.appendTo('.getpdf')
		.find('input')
		.val(jsonData);
}


function collectDOM(workflow) {
	switch(workflow) {
		case "chemspec":
			elements = $("div.articles_output").children('h2[class="model_header"], div#timestamp, h3#userInputs');
	        elements = elements.add('table#inputsTable'); // user inputs
	        elements = elements.add('h4#pka, dl#pkaValues'); // pKa values

	        var parentTitle = $('table#msMain td:first h4');
	        var parentImage = $('#parent_div img'); // parent species
	        // var parentTable = $('#parent_div table');
	        // elements = elements.add(parentTitle).add(parentImage).add(parentTable);
	        elements = elements.add(parentTitle).add(parentImage);
	        
	        var test = $('table#msMain td#ms-cell').children();

	        var ms = $('table#msMain td#ms-cell').children().not($('div.chemspec_molecule'));

	        // removes SVG (keeps hidden img version) for PDF
	        $(ms).each(function () {
	        	$(this).find('div.metabolite_img svg').remove();
	        });

	        elements = elements.add(ms);
	        var majorMS = $('h4#majorMS, #majorMS_div img, #majorMS_div table');
	        // var majorMS = $('h4#majorMS, #majorMS_div svg, #majorMS_div table');
	        elements = elements.add(majorMS);
	        var taut = $('h4#taut, p.taut-percent, #taut_div img, #taut_div table');
	        elements = elements.add(taut);
	        var stereo = $('h4#stereo, #stereo_div img, #stereo_div table');
	        elements = elements.add(stereo);
	        return elements;
	    case "pchemprop":

	    	var pchem_elements = $('div.articles_output').children().not(':hidden, div#export_menu').clone();
	    	// elements = $('div.articles_output').children().not(':hidden, div#export_menu');
	    	var ph = $(pchem_elements).find('#id_kow_ph').val();
	    	$(pchem_elements).find('#id_kow_ph').parent('h3').append(ph);
	    	$(pchem_elements).find('p, td.colorKey, input').remove();

	    	// elements.add(pchem_elements);

	    	return pchem_elements;
	   	case "gentrans":
	   		elements = $("div.articles_output").children('h2[class="model_header"], div#timestamp, h3#userInputs');
	        elements = elements.add('table#inputsTable'); // user inputs
	        elements = elements.add('h3#reactionPathways');
	        return elements;
	    default:
	    	elements = null;
	    	return elements;
	}
}


function getWorkflow() {
	var path = window.location.href;
	if (path.indexOf("chemspec") > -1) {
		return "chemspec";
	}
	else if (path.indexOf("pchemprop") > -1) {
		return "pchemprop";
	}
	else if (path.indexOf("gentrans") > -1) {
		return "gentrans";		
	}
	else { return null; }
}


function pickOutPka(html_string) {
	var pka_obj = {};
	var pkas = $.parseHTML(html_string);
	var pka_string = "";
	$(pkas).each(function () {
		var key_val_array = $(this).text().split(': '); // "pka0: 1.23"
		pka_obj[key_val_array[0]] = key_val_array[1];
	});
	return pka_obj;
}


</script>