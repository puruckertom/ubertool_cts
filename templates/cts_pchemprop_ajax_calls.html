<script type="text/javascript">

$(document).ready(function() {

    var checkedCalcsAndProps = {{checkedCalcsAndProps}};
    var structure = "{{structure}}";
    var kowPH = {{kow_ph}};

    startPchemPropDataCollection(structure, checkedCalcsAndProps, kowPH, null);

});


function startPchemPropDataCollection(structure, checkedCalcsAndProps, kowPH, node) {
    
    var url = "/cts/portal";
    var ws = ""; // web service to direct to (jchem or test et al.)
    var calcPropData;

    if (checkedCalcsAndProps == null) {
        return;
    } 

    for (var calc in checkedCalcsAndProps) {
        if (checkedCalcsAndProps.hasOwnProperty(calc)) {

            for (var i = 0; i < checkedCalcsAndProps[calc].length; i++) {

                var prop = checkedCalcsAndProps[calc][i];
                var calcPropData = {"chemical": structure, "calc": calc, "prop": prop};

                if (calc == "chemaxon") {
                    calcPropData.ws = "jchem";
                    calcPropData.service = "getPchemProps";
                    if (prop == "kow_wph") {
                        calcPropData.ph = kowPH;
                    }
                }
                else {
                    calcPropData.ws = "test";
                }

                var pchemForSelectedNode = parseFloat($('#gen-select-pchem').val());
                var workflowPath = window.location.href;

                if (workflowPath.indexOf("pchem") > -1 || pchemForSelectedNode == 0) {
                    var tblCell = $('.' + calc + '.' + prop);
                    $(tblCell).html('<img src="/static/images/loader.gif" id="spinner" />');
                    makeTheCall(url, calcPropData, node, true);
                }
                else {
                    // blockUI code (getting pchemprops for multiple metabolites)
                    // variable to keep track of displaying to pchem table or not
                    makeTheCall(url, calcPropData, node, false);
                }

                //makeTheCall(url, calcPropData, node, plotDataToTable);

            }
        }
    }

}


function makeTheCall(url, calcPropData, node, plotDataToTable) {
    $.ajax({ 
        url: url,
        type: "POST",
        dataType: "json",
        data: calcPropData,
        timeout: 30000,
        // tryCount: 0,
        // retryLimit: 3,
        success: function(data) {
            // console.log(this.tryCount);
            // console.log(this.retryLimit);
            parseResponseToPchemTable(data, node, false, plotDataToTable);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(errorThrown);
            var error = {
                "error": textStatus,
                "calc": calcPropData['calc'],
                "prop": calcPropData['prop']
            };
            parseResponseToPchemTable(error, null, false, plotDataToTable);
        }
    });
}


function parseResponseToPchemTable(response, node, hasData, plotDataToTable) {
    //map response to pchemprop output table:

    var calc = response['calc'];
    var prop = response['prop'];

    if (response.hasOwnProperty('error')) {
        $('.' + calc + '.' + prop).html(response['error']); //add error to table
        console.log(response['error']);
        return; //get out of there
    }

    var data;
    if (response.hasOwnProperty('data')) {
        if (calc != "chemaxon") {
            if (response['data'] == null) {
                data = "error";
                console.log("data has null value");
            }
            else if (response['data'].hasOwnProperty('error')) {
                data = "error";
                console.log(response['data']['error']);
            }
            else {
                data = response['data']['value'];
            }
        }
        else{
            data = response['data'];
        }
    }

    var workflowUrl = window.location.href;
    if (workflowUrl.indexOf("pchem") > -1) {
        // at the pchemprop workflow, simply display data:
        $('.' + calc + '.' + prop).html(organizeData(data)); //add data to table
    }
    else {
        if (node !== 'undefined' && node != null) {
            if (!node.data.hasOwnProperty('pchemprops')) {
                node.data.pchemprops = []; //array of with keys: calc, prop, data (single-level)
            }

            if (hasData == false) {
                node.data.pchemprops.push({"calc": calc, "prop": prop, "data": data});
            }

            if (plotDataToTable && currentNode) {
                $('.' + calc + '.' + prop).html(organizeData(data)); //add data to table
            }

            // only add html to table for node's table:
            //if (node.id == currentNode.id) {
            //    $('.' + calc + '.' + prop).html(organizeData(data)); //add data to table
            //}
        }
    }
}


function organizeData(data) {
    // organizes data, namely if it's
    // more than a single value

    if (typeof data === "number") {
        return data.toFixed(3);
    }

    if (typeof data === "string" || data == null) {
        return data;
    }

    var parsedData = "";
    for (item in data) {
        if (data.hasOwnProperty(item) && data[item] != null) {
            var itemVals = data[item];
            if (itemVals.length == 0) {
                parsedData += '<div class="pka-wrapper">' + item + ': none</div>';
            }
            else {
                for (var i = 0; i < itemVals.length; i++) {
                    var label = item + String(i).sub() +  ': ';
                    parsedData += '<div class="pka-wrapper">' + label + itemVals[i].toFixed(3) + '</div>';
                }
            }
        }
    }
    return parsedData;
}

</script>