<script type="text/javascript" src="/static/stylesheets/jquery.validate.js"></script>

<script type="text/javascript">
$(document).ready(function() {

	var validator = $("#form1").validate({
		rules: {
			upfile: "required"	
			}
	});

	var nodes = [];  // array of batch chems with modecular info

	// Do this stuff once file is uploaded:
	$('#upfile1').change(function () {

		var file = this.files[0];
		var textType = /text.*/;

		if (file.type.match(textType)) {
			var reader = new FileReader();
			reader.onload = function (e) {
				displayBatchFileChemicals(reader.result);			
			}
			reader.readAsText(file);
		}
		else {
			$('#fileDisplayArea').html("File not supported!");
		}

	});

	$('.submit').click(function (event) {
		
		// append nodes array to form for submission:
		var nodes_input = $.parseHTML('<input type="hidden" name="nodes"/>');
		$(nodes_input).val(JSON.stringify(nodes));
		$('#form1').append(nodes_input);  // sends nodes array to backend

		$('#form1').append('<input type="hidden" name="run_type" value="batch" />');

		// $('form').parsley().validate("validate");
		// var valid = $('form').parsley().isValid();

	});


	function displayBatchFileChemicals(file_content) {

		// TODO: Get SMILES, and if already a part of the same call, get chem deats:

		var batch_chems = file_content.replace(/\n/g, ",").split(",");  // chemicals in array
		// getMolecularInfoForBatchChemicals(batch_chems);


		// only allow ten max for now:
		if (batch_chems.length > 10) {
			alert("Early batch version is only accepting a maximum of 10 chemicals at a time. This will be increased in the near future. Try reducing the number of chemicals in the file, refresh the page, and try again..");
			return;
		}


		// $('#fileDisplayArea').html(file_content);
		// $('#batchfilewrap').show();

		// // display p-chem table and submit button once file uploaded/displayed:
		// // $('#pchem_batch_wrap, #pchemprop_table').show();
		var batch_inputs = $('#pchem_batch_wrap');
		$(batch_inputs).show();
		$(batch_inputs).children().show();
		$('#cont, #reactionpathways').hide();  // todo: separate html and js in cts_gentrans_tree.html

		for (chem in batch_chems) {

			getMolecularInfoForBatchChemicals(batch_chems[chem], function (chem_results) {

				// molecular info for a batch chem returns here...

				var chemical_display;

				if (chem_results.status) {
					// valid chemical, normal stuff...
					chemical_display = chem_results.data.chemical;
				}
				else {
					// invalid chemical, display chemical and error, and don't use...
					chemical_display = '<p class="redFont">' + chem_results.chemical + " -- invalid chemical" + '</p>';  // ?????
				}


				$('#batch_list').append('<li>' + chemical_display + '</li>');

			});

		}

		$('#batchfilewrap').show();

	}


	function getMolecularInfoForBatchChemicals(chem, callback) {
		
		// for (chem in batch_chems) {

		// 	var chemical = batch_chems[chem];

		$.ajax({
		    url: '/cts/rest/molecule',
		    type: 'POST',
		    data: {'chemical': chem},
		    dataType: 'json',
		    timeout: 10000,
		    success: function(data) {
				console.log(data);

				if (data.status) {
					nodes.push(data.data);  // if valid, add to list of chems for processing
				}
				// else {
				// 	// something bad occurred...
				// 	// highlight chemical and add error message next to it on page...
				// }

				// return data;
				callback(data);

		    },
		    error: function(jqXHR, textStatus, errorThrown) {
				console.log(textStatus);
				// what to do here?
		    }
		});

		// }

	}


	// include batch-dependent script for enabling submit after
	// a reaction library AND pchem prop(s) are selected in 
	// gentrans batch input.



});

</script>
</form> <!-- end submit form -->
</div> <!-- End "articles" div -->
